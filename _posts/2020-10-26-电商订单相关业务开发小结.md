---
layout: post
title: "电商订单相关业务开发小结"
subtitle: ""
date: 2020-10-26 20:00:00
author: "cs"
header-img: "img/post-bg-2020-10-26.jpg"
tags: 
- 电商
---

#### 并发性问题

提交订单的时候会校验商品状态和库存、扣除库存、生成订单详情记录、订单记录以及清空对应的购物车。并发问题主要发生在对商品扣库存和校验，由于扣除和校验不是原子的，因此并发情况下会导致超卖的情况，因此需要对提交订单接口加锁。

#### 库存问题

订单在流转时，抓住几个状态点，加入购物车不会对库存进行任何操作，只需要保证加购的商品不超过最大的库存即可。  

提交生成订单的时候需要校验商品的状态，如果商品状态有问题需要给予前端提示，并且将失效商品拿出，重新计算有效商品的总价，此时库存的扣除应该是预扣，即扣除在 redis 中的库存量。当订单超时未支付，需要修改订单的状态为关闭，并且还原对应的库存。  

当订单正常支付时，通过支付的回调接口获取支付成功的信息，如果此时订单状态正常（待付款）扣除商品的实际库存（扣数据库），修改订单状态。如果订单状态为已关闭，代表用户支付超时，会直接进入退款流程，此时由于超时逻辑中已经对库存进行回滚，因此不需要对库存进行任何操作。

#### 金钱相关

金额等重要信息通过查询数据库实现，禁止使用前端传的金额数据，主要是出于实时性、有效性和安全性。金额的计算最后再进行四舍五入，如果出现无限小数，则比最后保留的位数多取两位进行计算。

#### 幂等性判断

订单支付回调的时候要进行幂等性判断，已经改变状态的订单或者已经存在的流水号就不能对订单状态进行操作。

#### 购物车

购物车的数据使用物理删除，由于后面的逻辑没有需要恢复购物车数据的需求，并且避免数据量增加太快。逻辑删除主要考虑重要数据且后期可能存在恢复数据的情况。

#### 重复消费

支付回调是通过消息队列实现，可能会出现多条消息的情况，为了避免重复消费，需要一张流水表记录订单支付和退款信息，回调接口需要去表中查询对应的流水是否存在。