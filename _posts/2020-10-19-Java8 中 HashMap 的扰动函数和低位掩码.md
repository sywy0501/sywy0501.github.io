---
layout: post
title: "Java8 中 HashMap 的扰动函数和低位掩码"
subtitle: ""
date: 2020-10-19 20:00:00
author: "cs"
header-img: "img/post-bg-2020-10-19.jpg"
tags: 
- Java
- Java 基础
---

#### 源码

```java
//Java8 中的散列值优化函数
static final int hash(Object key){
  int h;
  return (key==null)?0:(h=key.hashCode())^(h>>>16);
}
```

#### 分析

##### 低位掩码

key.hashCode()函数调用的是 key 键值类型自带的哈希函数，返回 int 型的散列值。Java 中 int 值得范围是带符号的 2 进制 32 位，前后加起来有 40 亿的映射空间，虽然这么大的范围很难出现碰撞，但是内存无法提供这么大的空间。因此，通过 h&(length-1) 得到的结果为数组的下标。数组长度选择 2 的整数次幂，这样长度-1 正好相当于一个“低位掩码”，与操作高位全都为 0，只保留地位作为数组下标访问。

##### 扰动函数

由于做了二次运算取下标，这样会导致产生哈希碰撞的概率增加，扰动函数是为了减少碰撞的概率。  

右位移 16 位，正好是 32 位的一半，自己的高半位和低半位做异或，是为了混合原始哈希码的高位和地位，来增大随机性，并且低位掺杂了高位的信息，高位的信息也被变相的保留下来。

