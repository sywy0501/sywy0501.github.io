---
layout: post
title: "Mysql实战45讲 —— 查询和更新的执行流程"
subtitle: ""
date: 2020-10-20 20:00:00
author: "cs"
header-img: "img/post-bg-2020-10-22.jpg"
tags: 
- 笔记
- MySQL
---



#### 一条查询的执行流程

##### 建立连接

命令输入之后会和数据库建立一个 TCP 连接，连接建立完成对用户名和密码进行验证，并且获取该用户在数据库中的权限。```show processlist``` 命令会显示当前的所有连接，默认连接闲置 8h 后会关闭，由 ```wait_timeout```参数控制，由于开启和关闭连接比较耗费性能，当我们在使用 MySQL 的过程中尽量使用长连接。但是如果全部使用长连接会导致某些时候 MySQL 的内存暴涨，因为 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的，这些资源在连接断开的时候才释放，长连接积累会导致内存占用过大被系统强行杀掉，MySQL 就会异常重启。  

**由于过多长连接导致内存暴涨的解决方案：** 

- 定期断开长连接。
- 执行```mysql_reset_connection```初始化连接资源。

##### 查询缓存

缓存中以key-value 形式存储，key 为 sql 语句，value 是查询结果。但是由于 MySQL 缓存失效的频率非常高，相比较维护缓存的开销，提升的效率得不偿失，所以并不建议开启缓存。

##### 分析器

如果没有命中缓存就开始执行 SQL，会先进入分析器进行 SQL 关键字识别和语法分析。

##### 优化器

当表中有多个索引时，决定使用哪个索引；多表关联时决定各个表的关联顺序。选择效率更高的那种 SQL 执行方案。

##### 执行器

- 先判断用户对该表是否有执行权限。如果没有权限，直接返回没有权限的错误信息；否则，继续执行。
- 打开表的时候，执行器会根据表的引擎定义，使用对应引擎提供的接口。

#### 一条更新语句的执行流程

与查询语句类似，多了 redo log 和 binlog。

##### redo log

当记录更新时，会先把记录写入 redo log，然后更新内存，这时候就算更新完成。InnoDB 会在适当的时侯将记录更新到磁盘。

```write pos```和```check point```用于 redo log 的记录。```write pos``` 记录当前位置，```check point```记录当前要擦除的位置，并会往后推移循环，擦除记录之前会把记录更新到数据文件。当 ```write pos``` 追上```check point ```表示 ```redo log``` 的空间满了，这时就不能继续执行新的更新，先停下擦除一些数据，再继续执行。

redo log 能保证即使数据库发生异常重启，之前提交的记录都不会丢失```crash-safe```。

##### binlog

binlog 用于记录完整的逻辑记录，所有的逻辑记录在 binlog 里都能找到，所以在备份恢复时，是以 binlog 为基础，通过其记录的完整逻辑操作，备份出一个和原库完整的数据。

##### redolog 和 binglog 区别

- binlog 是属于 server 层的日志，所有引擎都可以使用，而 redo log 是属于 InnoDB 的。
- redo log是循环写的，空间用完会完全擦除后继续，binlog 写完会切换下一个，并不会覆盖之前的日志，是追加写。

